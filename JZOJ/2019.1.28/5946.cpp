#include <cstdio>
#include <cstring>
#include <iostream>
#include <algorithm>
#define fo(i,x,y) for(int i=(x);i<=(y);++i)
#define fd(i,x,y) for(int i=(x);i>=(y);--i)
#define min(x,y) ((x)<(y)?(x):(y))
using namespace std;
const int mo=998244353,N=33333;
typedef long long ll;
int n,k,T,m;
ll ans;
ll qsm(ll a,int b)
{
	ll rt=1;
	fo(i,0,30)
	{
		if((1ll<<i)>b)return rt;
		if((1ll<<i)&b) rt=rt*a%mo;
		a=a*a%mo;
	}
	return rt;
}
int a0,a[110];
ll calc(ll n)
{
	fo(i,1,a0)
		if(qsm(n,a[i])==1) return a[i];
	return mo-1;
}
int main()
{
//	freopen("D:/LiuYuanHao/a.in","r",stdin);
//	freopen("D:/LiuYuanHao/a.out","w",stdout);
	 freopen("braid.in","r",stdin);
	 freopen("braid.out","w",stdout);
	scanf("%d",&T);
	a[1]=1;a[2]=2;a[3]=4;a[4]=7;a[5]=8;a[6]=14;a[7]=16;a[8]=17;a[9]=28;a[10]=32;a[11]=34;a[12]=56;a[13]=64;a[14]=68;a[15]=112;a[16]=119;a[17]=128;a[18]=136;a[19]=224;a[20]=238;a[21]=256;a[22]=272;a[23]=448;a[24]=476;a[25]=512;a[26]=544;a[27]=896;a[28]=952;a[29]=1024;a[30]=1088;a[31]=1792;a[32]=1904;a[33]=2048;a[34]=2176;a[35]=3584;a[36]=3808;a[37]=4096;a[38]=4352;a[39]=7168;a[40]=7616;a[41]=8192;a[42]=8704;a[43]=14336;a[44]=15232;a[45]=16384;a[46]=17408;a[47]=28672;a[48]=30464;a[49]=32768;a[50]=34816;a[51]=57344;a[52]=60928;a[53]=65536;a[54]=69632;a[55]=114688;a[56]=121856;a[57]=131072;a[58]=139264;a[59]=229376;a[60]=243712;a[61]=262144;a[62]=278528;a[63]=458752;a[64]=487424;a[65]=524288;a[66]=557056;a[67]=917504;a[68]=974848;a[69]=1048576;a[70]=1114112;a[71]=1835008;a[72]=1949696;a[73]=2097152;a[74]=2228224;a[75]=3670016;a[76]=3899392;a[77]=4194304;a[78]=4456448;a[79]=7340032;a[80]=7798784;a[81]=8388608;a[82]=8912896;a[83]=14680064;a[84]=15597568;a[85]=17825792;a[86]=29360128;a[87]=31195136;a[88]=35651584;a[89]=58720256;a[90]=62390272;a[91]=71303168;a[92]=124780544;a[93]=142606336;a[94]=249561088;a[95]=499122176;a[96]=998244352;
	a0=96;
	while(T--)
	{
		int x;
		scanf("%d%d%d%d",&n,&m,&x,&k);
		if(k==998244353){printf("%d\n",n-1);continue;}
		ans=calc(k);
		if(ans&1) ans=ans*2-1;
		ans=n-min(m,ans/2);
		printf("%lld\n",ans);
	}
	return 0;
}
